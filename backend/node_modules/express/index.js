const url = require('url');

function matchPath(routePath, reqPath) {
  if (!routePath) return {};
  const routeSeg = routePath.split('/').filter(Boolean);
  const reqSeg = reqPath.split('/').filter(Boolean);
  if (routeSeg.length !== reqSeg.length) return null;
  const params = {};
  for (let i = 0; i < routeSeg.length; i++) {
    const r = routeSeg[i];
    const s = reqSeg[i];
    if (r.startsWith(':')) {
      params[r.slice(1)] = decodeURIComponent(s);
    } else if (r !== s) {
      return null;
    }
  }
  return params;
}

function createApp() {
  const stack = [];

  const app = function(req, res) {
    const method = req.method.toLowerCase();
    const pathname = url.parse(req.url).pathname;
    let idx = 0;

    function next(err) {
      const layer = stack[idx++];
      if (!layer) return;
      if (layer.method !== 'use' && layer.method !== method) return next(err);
      let params = {};
      if (layer.path) {
        params = matchPath(layer.path, pathname);
        if (!params) return next(err);
      }
      req.params = params;
      if (layer.method === 'use' && layer.path && !pathname.startsWith(layer.path)) return next(err);
      layer.handler(req, res, next);
    }
    next();
  };

  app.use = function(path, handler) {
    if (typeof path === 'function') {
      handler = path;
      path = undefined;
    }
    stack.push({ method: 'use', path, handler });
  };

  ['get','post','put','delete'].forEach(m => {
    app[m] = function(path, handler) {
      stack.push({ method: m, path, handler });
    };
  });

  return app;
}

function express() {
  return createApp();
}

express.json = () => (_req, _res, next) => next();
express.static = () => (_req, _res, next) => next();
express.Router = () => createApp();

module.exports = express;
